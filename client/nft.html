<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://npmcdn.com/moralis@latest/dist/moralis.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
  </head>
  <body>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
    <script type="module" src="./nft.js"></script>
    <div class="container">
        <h2 id="username">User: </h2>
        <h2 id="money">Tokens: </h2>
    </div>
    <div class="form-group">
        <div class="input-group mb-3">
          <input id="name" type="text" class="form-control" placeholder="NFT Name" aria-label="URL" aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-3">
          <input  id="description" type="text" class="form-control" placeholder="Description" aria-label="URL" aria-describedby="basic-addon1">
        </div>
        <div class="input-group mb-3">
          <input type="file" id="file">
        </div>
    </div>
    <br>
    <div>  
        <button  class="btn btn-primary" id="upload" onclick="upload();">Upload and Mint</button>
    </div>
    <br>
    <br>
</body>
    <script>
      Moralis.initialize("7eWpbh0xsRKuUQNHJ8nhwWiMfomgP76NFM8rnsDZ");
Moralis.serverURL = "https://accoohwmalee.usemoralis.com:2053/server";

var user;
user = Moralis.User.current();
if (!user) {
    user =  await Moralis.Web3.authenticate();
}
const moneyHTML = document.getElementById("money")
const usernameHTML = document.getElementById("username")
usernameHTML.innerHTML = "User: " + user.get("ethAddress")
const navigateHTML = document.getElementById("navigate_game")
const nft_contract_address = "0x88624DD1c725C6A95E223170fa99ddB22E1C6DDD"

console.log(user.get("ethAddress"));

async function upload(){

    const fileInput = document.getElementById("file");
    const data = fileInput.files[0];
    
    const imageFile = new Moralis.File(data.name, data);
    
    document.getElementById('upload').setAttribute("disabled", null);
    document.getElementById('file').setAttribute("disabled", null);
    document.getElementById('name').setAttribute("disabled", null);
    document.getElementById('description').setAttribute("disabled", null);
    
    await imageFile.saveIPFS();
    const imageURI = imageFile.ipfs();
    const metadata = {
      "name":document.getElementById("name").value,
      "description":document.getElementById("description").value,
      "image":imageURI
    }
    const metadataFile = new Moralis.File("metadata.json", {base64 : btoa(JSON.stringify(metadata))});
    await metadataFile.saveIPFS();
    const metadataURI = metadataFile.ipfs();
    const txt = await mintToken(metadataURI).then(notify)

}

  
async function mintToken(_uri){
    
    const encodedFunction = web3.eth.abi.encodeFunctionCall({
        name: "mintToken",
        type: "function",
        inputs: [{
            type: 'string',
            name: 'tokenURI'
        }]
    }, [_uri]);

    const transactionParameters = {
        to: nft_contract_address,
        from: user.get('ethAddress'),
        data: encodedFunction
    };
    
    const txt = await ethereum.request({
        method: 'eth_sendTransaction',
        params: [transactionParameters]
    });
    return txt
}

async function notify(_txt){
    document.getElementById("resultSpace").innerHTML =  
        `<input disabled = "true" id="result" type="text" class="form-control" placeholder="Description" aria-label="URL" aria-describedby="basic-addon1" value="Your NFT was minted in transaction ${_txt}">`;
} 
      

    </script>
</html>